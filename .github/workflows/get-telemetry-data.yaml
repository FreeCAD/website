name: Get Telemetry Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * 0'  # Weekly on Sunday 16:00 UTC

permissions:
  contents: write

jobs:
  telemetry_data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Restore Telemetry cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: telemetry-cache-${{ github.ref_name }}
          restore-keys: |
            telemetry-cache-

      - name: Fetch JSON file
        run: |
          curl -sSL https://www.freecad.org/chart_data.json -o chart_data_raw.json

      - name: Check fetched JSON
        run: |
          cat chart_data_raw.json

      - name: Ensure the JSON file is not empty
        run: |
          if [ ! -s chart_data_raw.json ]; then
            echo "❌ chart_data_raw.json is empty or not found"
            exit 1
          else
            echo "✅ chart_data_raw.json fetched successfully"
          fi

      - name: Validate JSON file (with lenient jq)
        run: |
          jq --ascii-output empty chart_data_raw.json || exit 1

      - name: Validate JSON file
        run: |
          if ! jq empty chart_data_raw.json; then
            echo "❌ Invalid JSON format"
            exit 1
          else
            echo "✅ Valid JSON format"
          fi

      - name: Extract most common totalUsers
        id: extract_total
        run: |
          TOTAL_USERS=$(jq -r '
            to_entries
            | map(select(.value.totalUsers != null) | .value.totalUsers)
            | group_by(.)
            | sort_by(length)
            | reverse
            | .[0][0]
          ' chart_data_raw.json)

          echo "totalUsers=$TOTAL_USERS"
          echo "totalUsers=$TOTAL_USERS" >> "$GITHUB_OUTPUT"

      - name: Log invalid keys
        run: |
          INVALID=$(jq -r '
            to_entries
            | map(select(.key != "totalUsers"))
            | map(select(
                (.value.labels == null)
                or (.value.data == null)
                or ((.value.labels | length) != (.value.data | length))
              ))
            | .[].key
          ' chart_data_raw.json)

          if [[ -n "$INVALID" ]]; then
            echo "⚠️ Invalid keys (due to missing or mismatched labels/data):"
            echo "$INVALID"
          else
            echo "✅ No invalid keys found."
          fi

      - name: Clean and transform JSON
        run: |
          jq --argjson totalUsers "${{ steps.extract_total.outputs.totalUsers }}" '
            to_entries
            | map(
              select(
                .key != "totalUsers" and
                (.value | type == "object") and
                .value.labels != null and
                .value.data != null and
                (.value.labels | length) == (.value.data | length)
              )
              | {
                  key: .key,
                  value: (
                    [range(0; .value.labels | length)]
                    | map({
                        (.value.labels[.]): .value.data[.]
                      })
                    | add
                  )
                }
              )
            | from_entries
            + { totalUsers: $totalUsers }
          ' chart_data_raw.json > data/telemetry_chart_data.json

      - name: Commit and push cleaned Telemetry Data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/telemetry_chart_data.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "Action: update Telemetry Data - $DATE"
          git push

      - name: Save updated cache
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: telemetry-cache-${{ github.ref_name }}
