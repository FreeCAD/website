name: Get Telemetry Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * 0"  # Weekly on Sunday 22:00 UTC

permissions:
  contents: write

jobs:
  fetch-telemetry:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Restore Telemetry Cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ${{ runner.temp }}/telemetry_cache
          key: telemetry-${{ github.ref_name }}
          restore-keys: |
            telemetry-${{ github.ref_name }}-
            telemetry-

      - name: Fetch and validate remote Telemetry JSON
        id: fetch-validate
        run: |
          set -euo pipefail

          JSON_FILE="chart_data_raw.json"
          CACHE_DIR="${{ runner.temp }}/telemetry_cache"
          HASH_FILE="$CACHE_DIR/hash.txt"

          mkdir -p "$CACHE_DIR"

          echo "Fetching JSON..."
          curl -sSL --fail https://www.freecad.org/chart_data.json -o "$JSON_FILE"

          if [ ! -s "$JSON_FILE" ]; then
            echo "❌ $JSON_FILE missing or empty"
            exit 1
          fi

          NEW_HASH=$(sha256sum "$JSON_FILE" | awk '{print $1}')
          echo "New hash: $NEW_HASH"

          if [ -f "$HASH_FILE" ] && [ "$(cat "$HASH_FILE")" = "$NEW_HASH" ]; then
            echo "No change detected."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "$NEW_HASH" > "$HASH_FILE"
            echo "Change detected."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

          if ! jq empty "$JSON_FILE"; then
            echo "❌ Invalid $JSON_FILE format"
            exit 1
          fi

          echo "✅ $JSON_FILE is valid and non-empty"

      - name: Extract most common totalUsers
        if: steps.fetch-validate.outputs.changed == 'true'
        id: extract_total
        run: |
          set -euo pipefail

          TOTAL_USERS=$(jq -r '
            to_entries
            | map(select(.value.totalUsers != null) | .value.totalUsers)
            | sort
            | group_by(.)
            | last | .[0] // "No totalUsers found"
          ' chart_data_raw.json)

          echo "totalUsers=$TOTAL_USERS"
          echo "totalUsers=$TOTAL_USERS" >> "$GITHUB_OUTPUT"

      - name: Log invalid keys
        if: steps.fetch-validate.outputs.changed == 'true'
        run: |
          set -euo pipefail

          INVALID=$(jq -r '
            to_entries
            | map(select(.key != "totalUsers"))
            | map(select(
                (.value.labels == null)
                or (.value.data == null)
                or ((.value.labels | length) != (.value.data | length))
              ))
            | .[].key
          ' chart_data_raw.json)

          if [[ -n "$INVALID" ]]; then
            echo "⚠️ Invalid keys (due to missing or mismatched labels/data):"
            echo "$INVALID"
          else
            echo "✅ No invalid keys found."
          fi

      - name: Clean and transform Telemetry JSON
        if: steps.fetch-validate.outputs.changed == 'true'
        run: |
          set -euo pipefail

          mkdir -p data

          jq --argjson totalUsers "${{ steps.extract_total.outputs.totalUsers }}" '
            with_entries(
              if (.value.labels and .value.data) then
                . as {key: $k, value: $v} |
                {
                  key: $k,
                  value: (
                    [range(0; ($v.labels | length))]
                    | map({ ("\($v.labels[.])"): $v.data[.] })
                    | add
                  )
                }
              else
                .
              end
            )
            | . + { totalUsers: $totalUsers }
          ' chart_data_raw.json > data/telemetry_data.json

      - name: Commit and push cleaned Telemetry Data
        if: steps.fetch-validate.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/telemetry_data.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "Action: update Telemetry Data - $DATE"
          git push

      - name: Save Telemetry Cache
        id: cache-save
        if: steps.fetch-validate.outputs.changed == 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ runner.temp }}/telemetry_cache
          key: telemetry-${{ github.ref_name }}
