name: Get Telemetry Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * 0'  # Weekly on Sunday 16:00 UTC

permissions:
  contents: write

jobs:
  telemetry_data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Restore Telemetry cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: telemetry-cache-${{ github.ref_name }}
          restore-keys: |
            telemetry-cache-

      - name: Fetch JSON file
        run: |
          curl -s http://www.freecad.org/chart_data.json -o chart_data_raw.json

      - name: Extract most common totalUsers
        id: extract_total
        run: |
          TOTAL_USERS=$(jq -r '
            to_entries
            | map(select(.value.totalUsers != null) | .value.totalUsers)
            | group_by(.)
            | sort_by(length)
            | reverse
            | .[0][0]
          ' chart_data_raw.json)

          echo "totalUsers=$TOTAL_USERS" >> $GITHUB_OUTPUT

      - name: Log invalid keys
        run: |
          INVALID=$(jq -r '
            to_entries
            | map(select(.key != "totalUsers"))
            | map(select(
                (.value.labels == null)
                or (.value.data == null)
                or ((.value.labels | length) != (.value.data | length))
              ))
            | .[].key
          ' chart_data_raw.json)

          if [[ -n "$INVALID" ]]; then
            echo "⚠️ Invalid keys (due to missing or mismatched labels/data):"
            echo "$INVALID"
          else
            echo "✅ No invalid keys found."
          fi

      - name: Clean and transform JSON
        run: |
          jq --argjson totalUsers "${{ steps.extract_total.outputs.totalUsers }}" '
            to_entries
            | map(
                select(.key != "totalUsers")
                | select(.value.labels != null and .value.data != null)
                | select((.value.labels | length) == (.value.data | length))
                | {
                    key: .key,
                    value: (
                      [range(0; .value.labels | length)]
                      | map({
                          (.value.labels[.]): .value.data[.]
                        })
                      | add
                    )
                  }
              )
            | from_entries
            + { totalUsers: $totalUsers }
          ' chart_data_raw.json > data/telemetry_chart_data.json

      - name: Commit and push cleaned Telemetry Data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/telemetry_chart_data.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          DATE=$(date -u +"%Y-%m-%d")
          git commit -m "Action: update Telemetry Data - $DATE"
          git push

      - name: Save updated cache
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: telemetry-cache-${{ github.ref_name }}
