{{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) -}}
<figure class="entry-cover">
  {{- $responsiveImages := (.Params.cover.responsiveImages | default site.Params.cover.responsiveImages) | default true -}}
  {{- $addLink := (and site.Params.cover.linkFullImages (not $.IsHome)) -}}
  {{- $cover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) -}}

  {{- if $cover -}}{{/* i.e it is present in page bundle */}}
    {{- if $addLink }}
      <a href="{{ (path.Join .RelPermalink .Params.cover.image) }}" target="_blank" rel="noopener noreferrer">
    {{- end -}}
    {{- $sizes := (slice "500" "1000") -}}
    {{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif") -}}
    {{- $prod := (hugo.IsProduction | or (eq site.Params.env "production")) -}}
    {{- if (and (in $processableFormats $cover.MediaType.SubType) ($responsiveImages) (eq $prod true)) -}}
      <img
        srcset="
          {{ range $size := $sizes -}}
            {{- if (ge $cover.Width $size) -}}
              {{- printf "%s %s" (($cover.Resize (printf "%sx" $size)).Permalink) (printf "%sw ," $size) -}}
            {{- end -}}
          {{- end -}}
          {{ $cover.Permalink }} {{ printf "%dw" ($cover.Width) }}"
        sizes="
          {{- if .Store.Get "articles" -}}
            {{ index $sizes 0 }}px
          {{- else -}}
            (max-width: {{ index $sizes 0 }}px) {{ index $sizes 0 }}px, (max-width: {{ index $sizes 1 }}px) {{ index $sizes 1 }}px, 100vw
          {{- end -}}"
        src="{{ $cover.Permalink }}"
        alt="{{ $alt }}"
        width="{{ $cover.Width }}"
        height="{{ $cover.Height }}">
    {{- else -}}{{/* Unprocessable image or responsive images disabled */}}
      <img src="{{ (path.Join .RelPermalink .Params.cover.image) }}" alt="{{ $alt }}">
    {{- end -}}
  {{- else -}}{{/* For absolute urls and external links, no img processing here */}}
    {{- if $addLink }}
      <a href="{{ (.Params.cover.image) | absURL }}" target="_blank" rel="noopener noreferrer">
    {{- end -}}
    <img src="{{ (.Params.cover.image) | absURL }}" alt="{{ $alt }}">
  {{- end -}}
  {{- if $addLink }}
    </a>
  {{- end -}}

  {{/*  Display Caption  */}}
  {{- if $.IsHome -}}
    {{- with .Params.cover.caption -}}
      <p>
        {{ .RenderString }}
      </p>
    {{- else -}}
      {{- errorf "Unable to get %q as cover caption" .Params.cover.caption -}}
    {{- end -}}
  {{- end -}}
</figure>
