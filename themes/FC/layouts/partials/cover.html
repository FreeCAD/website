{{- $cover := (.Resources.ByType "image").GetMatch (printf "*%s*" (.Params.cover.image)) -}}
{{- $alt := (.Params.cover.alt | default .Params.cover.caption | plainify) -}}
{{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif" "webp") -}}
{{- $prod := (hugo.IsProduction | or (eq site.Params.env "production")) -}}
{{- $responsiveImages := (.Params.cover.responsiveImages | default site.Params.cover.responsiveImages) | default true -}}
{{- $sizes := (slice "500" "1000") -}}
{{- $resizeFormat := "webp" -}}

<figure class="entry-cover">
  {{- if $cover -}}{{/* i.e it is present in page bundle */}}
    {{- if (and (in $processableFormats $cover.MediaType.SubType) ($responsiveImages) (eq $prod true)) -}}
      <img
        srcset="
          {{- if (ge $cover.Width (index $sizes 0)) -}}
            {{- printf "%s %s" (($cover.Crop (printf "%sx%s center %s" (index $sizes 0) (index $sizes 0) $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 0)) -}}
          {{- end -}}
          {{- if (ge $cover.Width (index $sizes 1)) -}}
            {{- printf "%s %s" (($cover.Resize (printf "%sx %s" (index $sizes 1) $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 1)) -}}
          {{- end -}}
          {{ $cover.RelPermalink }} {{ printf "%dw" ($cover.Width) }}"
        sizes="
          {{- if .Store.Get "articles" -}}
            {{ index $sizes 0 }}px
          {{- else -}}
            (max-width: {{ index $sizes 1 }}px) {{ index $sizes 1 }}px, 100vw
          {{- end -}}"
        src="{{ $cover.RelPermalink }}"
        alt="{{ $alt }}"
        width="{{ $cover.Width }}"
        height="{{ $cover.Height }}"
        fetchpriority="high">
    {{- else -}}{{/* Unprocessable image or responsive images disabled */}}
      <img src="{{ (path.Join .RelPermalink .Params.cover.image) }}" alt="{{ $alt }}">
    {{- end -}}

  {{- else -}}{{/* For absolute urls and external links, no img processing here */}}
    <img src="{{ (.Params.cover.image) | absURL }}" alt="{{ $alt }}">
  {{- end -}}

  {{/*  Display Caption  */}}
  {{- if $.IsHome -}}
    {{- with .Params.cover.caption -}}
      <p>
        {{ .RenderString }}
      </p>
    {{- else -}}
      {{- errorf "Unable to get %q as cover caption" .Params.cover.caption -}}
    {{- end -}}
  {{- end -}}
</figure>
