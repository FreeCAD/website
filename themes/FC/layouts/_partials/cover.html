{{- $cover := false -}}
{{- $alt := "" -}}
{{- $anchor := "" -}}

{{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif" "webp") -}}
{{- $prod := (hugo.IsProduction | or (eq site.Params.env "production")) -}}
{{- $responsiveImages := (.Params.cover.responsiveImages | default site.Params.cover.responsiveImages) | default true -}}
{{- $sizes := (slice "250" "500" "1000" "2000") -}}
{{- $resizeFormat := "webp" -}}

{{- $pageCover := .Params.cover.image -}}
{{- if $pageCover -}}
  {{- $cover = (.Resources.ByType "image").GetMatch (printf "*%s*" $pageCover) -}}
  {{- $anchor = .Params.cover.anchor | default "Smart" | plainify -}}
  {{- $alt = .Params.cover.alt | default .Params.cover.caption | plainify -}}
{{- end -}}

{{- if not $cover -}}
  {{- $sectionPage := site.GetPage (printf "/%s" .Section) -}}
  {{- $category := .Params.categories -}}
  {{- if $category -}}
    {{- with $sectionPage -}}
      {{- $cover = (.Resources.ByType "image").GetMatch (printf "*%s*" $category) -}}
    {{- end -}}
    {{- if $cover -}}
      {{- $alt = printf "%s cover" $category -}}
    {{- end -}}
  {{- end -}}
  {{- if not $cover -}}
    {{- with $sectionPage -}}
      {{- $cover = (.Resources.ByType "image").GetMatch (printf "*%s*" .Params.cover.image) -}}
      {{- $alt = (.Params.cover.alt | default $alt) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $cover -}}
<figure class="entry-cover">
  {{- if $cover -}}{{/* i.e it is present in page bundle */}}
    {{- if (and (in $processableFormats $cover.MediaType.SubType) ($responsiveImages) (eq $prod true)) -}}
      <img
        srcset="
          {{- if (ge $cover.Width (index $sizes 1)) -}}
            {{- printf "%s %s" (($cover.Fill (printf "%sx%s %s %s" (index $sizes 1) (index $sizes 0) $anchor $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 0)) -}}
          {{- end -}}
          {{- if (ge $cover.Width (index $sizes 2)) -}}
            {{- printf "%s %s" (($cover.Fill (printf "%sx%s %s %s" (index $sizes 1) (index $sizes 2) $anchor $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 1)) -}}
            {{- printf "%s %s" (($cover.Fill (printf "%sx%s %s %s" (index $sizes 2) (index $sizes 1) $anchor $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 2)) -}}
            {{- printf "%s %s" (($cover.Fill (printf "%sx%s %s %s" (index $sizes 3) (index $sizes 2) $anchor $resizeFormat)).RelPermalink) (printf "%sw, " (index $sizes 3)) -}}
          {{- end -}}
          {{ $cover.RelPermalink }} {{ printf "%dw" ($cover.Width) }}"
        sizes="
          {{- if .Store.Get "articles" -}}
            {{ index $sizes 0 }}px
          {{- else -}}
            (max-width: {{ index $sizes 1 }}px) {{ index $sizes 1 }}px,
            ((min-width: {{ index $sizes 1 }}px) and (max-width: {{ index $sizes 2 }}px)) {{ index $sizes 2 }}px,
            ((min-width: {{ index $sizes 2 }}px) and (max-width: {{ index $sizes 3 }}px)) {{ index $sizes 3 }}px,
            100vw
          {{- end -}}"
        src="{{ $cover.RelPermalink }}"
        alt="{{ $alt }}"
        width="{{ $cover.Width }}"
        height="{{ $cover.Height }}"
          {{- if .Store.Get "articles" -}}
            loading="lazy"
          {{- else -}}
            fetchpriority="high"
          {{- end -}}>
    {{- else -}}{{/* Unprocessable image or responsive images disabled */}}
      <img src="{{ (path.Join .RelPermalink $cover) }}" alt="{{ $alt }}">
    {{- end -}}

  {{- else -}}{{/* For absolute urls and external links, no img processing here */}}
    <img src="{{ ($cover) | absURL }}" alt="{{ $alt }}">
  {{- end -}}

  {{/*  Display Caption  */}}
  {{- if $.IsHome -}}
    {{- with .Params.cover.caption -}}
      <p>
        {{ .RenderString }}
      </p>
    {{- else -}}
      {{- errorf "Unable to get %q as cover caption" .Params.cover.caption -}}
    {{- end -}}
  {{- end -}}
</figure>
{{- end -}}