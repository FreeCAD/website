{{- $url := urls.Parse .Destination -}}
{{- $sizes := (slice "500" "1000") -}}
{{- $resizeFormat := "webp" -}}
{{- $id := delimit (shuffle (seq 1 9)) "" -}}

{{- if $url.Scheme -}}

  {{/* third party image */}}
  {{- with try (resources.GetRemote .Destination) -}}
    {{- with .Err -}}
      {{- errorf "%s" . -}}
    {{- else with .Value -}}
      <img loading="lazy" src="{{ .RelPermalink | safeURL }}" alt="{{ $.Text }}"
        {{- with $.Title -}}
          title="{{ . | plainify }}"
        {{- end -}} />
    {{- end -}}
  {{- else -}}
    {{- errorf "Unable to get remote resource %q" .Destination -}}
  {{- end -}}
{{- else -}}

  {{/* internal image */}}
  {{- $img := .Page.Resources.GetMatch .Destination -}}
  {{- if not $img -}}
    {{- $img = resources.Get .Destination -}}
  {{- end -}}
  {{- if $img -}}
    {{- if eq $img.MediaType.MainType "video" -}}
      <figure>
      <video class="video-shortcode" preload="metadata" controls>
        <source src="{{ $img.RelPermalink }}">
        There should have been a video here but your browser does not seem to support it.
      </video>
      </figure>
    {{- else -}}
      <button aria-label="{{- i18n "zoom" | default "Zoom image" -}}" popovertarget="img{{- $id -}}">
        <img loading="lazy"
          srcset="
            {{ range $sizeImage := $sizes -}}
              {{- if (ge $img.Width $sizeImage) -}}
                {{- printf "%s %s" (($img.Resize (printf "%sx %s" $sizeImage $resizeFormat)).RelPermalink | safeURL) (printf "%sw, " $sizeImage) -}}
              {{- end -}}
            {{- end -}}
            {{ $img.RelPermalink }} {{ printf "%dw" ($img.Width) }}"
          sizes="
            {{- if .Page.Store.Get "blocks" -}}
              (max-width: {{ index $sizes 1 }}px) {{ index $sizes 0 }}px, 35vw
            {{- else -}}
              (max-width: {{ index $sizes 0 }}px) {{ index $sizes 0 }}px, (max-width: {{ index $sizes 1 }}px) {{ index $sizes 1 }}px, 70vw
            {{- end -}}"
          src="{{ $img.RelPermalink | safeURL }}"
          width="{{ $img.Width }}"
          height="{{ $img.Height }}"
          alt="{{ $.Text }}"
          {{- with $.Title -}}
            title="{{ . | plainify }}"
          {{- end -}} >
      </button>
      <div id="img{{- $id -}}" popover>
        <img loading="lazy" src="{{ $img.RelPermalink | safeURL }}">
        <button class="close" popovertarget="img{{- $id -}}" popovertargetaction="hide">
          âœ•
        </button>
      </div>
    {{- end -}}
  {{- else -}}
    {{- warnf "No image found for %s from %s" .Destination .Page.File -}}
  {{- end -}}
{{- end -}}
