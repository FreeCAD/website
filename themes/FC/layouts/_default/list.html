{{- define "main" -}}

{{- if not hugo.IsProduction -}}
  {{- partial "debug.html" . -}}
{{- end -}}

{{- if .IsHome | and .Title -}}
  {{- partial "hero.html" . -}}
{{- end -}}

{{- if not .IsHome | and .Title -}}
  <header>
    {{- if or (eq .Section "news") (eq .Kind "term") -}}
      <ul class="category-list">
        {{- range .Sites.Default.Taxonomies.categories -}}
          <li>
            <a href="{{ .Page.RelPermalink }}">
              {{ .Page.LinkTitle }}
            </a>
          </li>
        {{- end -}}
      </ul>
    {{- end -}}

    <h1 class="title">
      {{- if eq .Kind "term" -}}
        {{ .Data.Singular }}: {{ end }}
      {{ .Title | .RenderString }}
    </h1>

    {{- if .Description -}}
      <h2 class="description">
        {{ .Description | .RenderString }}
      </h2>
    {{- end -}}

    {{- if eq .Kind "term" -}}
      {{- with .Site.GetPage "news" -}}
        {{- partial "cover.html" . -}}
      {{- end -}}
    {{- else -}}
      {{- partial "cover.html" . -}}
    {{- end -}}
  </header>
{{- end -}}

{{- if eq .Type "guide" }}
  {{- partial "content.html" . -}}
{{- end -}}

{{/* get the latest pages from the current section, and fill in the missing translated pages from the first site (currently English) */}}
{{- $pages := where (.RegularPages | lang.Merge .Sites.Default.RegularPages) "Section" .Section -}}

{{- if .IsHome -}}
  {{/* get the latest news articles by category except the ones with "hero" parameters in front matter */}}
  {{- $homePages := slice -}}
  {{- range .Site.Taxonomies.categories.ByCount -}}
    {{- range first 1 (where .Pages "Params.hero" "ne" true) -}}
      {{- $homePages = $homePages | append . -}}
    {{- end -}}
  {{- end -}}
  {{- $paginateLimit := .Params.paginate | default 6 -}}
  {{- $pages = first $paginateLimit $homePages -}}
{{- end -}}

{{- if eq .Type "contribute" }}
  {{- $lang := slice -}}
  {{- range .Translations -}}
    {{- $lang = $lang | append .Sections -}}
  {{- end -}}
  {{- $pages = where (lang.Merge .Sections $lang) "Type" "guide" -}}
  {{- $pages = $pages | append (.Site.GetPage "telemetry")}}
{{- end -}}

{{- if or (eq .Kind "term") (eq .Type "guide") -}}
  {{- $pages = .RegularPages -}}
{{- end -}}

{{/* related issue: https://github.com/gohugoio/hugo/issues/9003 */}}
{{- $paginator := "" -}}
{{- if (.Param "paginate") -}}
  {{- $paginator = .Paginate $pages (.Param "paginate") -}}
{{- else -}}
  {{- $paginator = .Paginate $pages -}}
{{- end -}}

<section class="articles">
  {{- range $index, $page := $paginator.Pages -}}
    <article>
      {{- partial "category.html" . -}}
      <a href="{{ .Permalink }}"
        alt="ARTICLE"
        aria-label="{{ .Title | plainify }}"
        title="{{ .Title | plainify }}">
        {{- with .Store -}}
          {{- .Set "articles" true -}}
        {{- end -}}
        {{- partial "cover.html" . -}}
        {{- with .Store -}}
          {{- .Delete "articles" -}}
        {{- end -}}
        {{- if not .Date.IsZero -}}
          <span class="entry-date">
            <time datetime="{{ .Date }}">
              {{ .Date | time.Format ":date_long" }}
            </time>
          </span>
        {{- end -}}
        <h3 class="entry-title">
          <span>
            {{ .Title | .RenderString }}
          </span>
          {{- if .Draft }}
            <sup>
              <span class="entry-isdraft">
                [{{- i18n "draft" | default "Draft" -}}]
              </span>
            </sup>
          {{- end -}}
        </h3>
        {{- if (ne (.Param "hideSummary") true) -}}
        <p class="entry-description">
          {{- if .Description -}}
            {{ .Description | .RenderString }}
          {{- end -}}
        </p>
        {{- end -}}
      </a>
    </article>
  {{- end -}}
</section>

{{/* Get the content for the Homepage. */}}
{{- if .IsHome -}}
  {{- with (index (where (.RegularPages | lang.Merge .Sites.Default.RegularPages) "Type" "homepage") 0) -}}
    {{- partial "content.html" . -}}
  {{- end -}}
{{- end -}}

{{- if gt $paginator.TotalPages 1 -}}
  <footer class="list-footer">
    <nav class="list-pagination">
      {{- if $paginator.HasPrev -}}
        <a class="prev"
          href="{{ $paginator.Prev.URL }}"
          alt="PREVIOUS"
          aria-label="{{ i18n "prev_page" | default "Prev Page" }}"
          title="{{ i18n "prev_page" | default "Prev Page" }}">
          ◀ {{ i18n "prev_page" | default "Prev Page" }}
        </a>
      {{- end -}}
      {{- if $paginator.HasNext -}}
        <a class="next"
          href="{{ $paginator.Next.URL }}"
          alt="NEXT"
          aria-label="{{ i18n "next_page" | default "Next Page" }}"
          title="{{ i18n "next_page" | default "Next Page" }}">
          {{ i18n "next_page" | default "Next Page" }} ▶
        </a>
      {{- end -}}
    </nav>
  </footer>
{{- end -}}

{{- end -}}
{{- /* end main */ -}}
