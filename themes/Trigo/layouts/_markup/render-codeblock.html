{{- /* Custom highlight rendering for code blocks:

  - Use default highlight with options and attributes.
  - Add file name option above rendered code.
  - Add trim option to remove leading and trailing whitespaces.

  @param {string} [file] File name or URL to display above the rendered code.
  @param {bool} [trim=true] Whether to trim leading and trailing whitespaces.

  @returns {template.HTML}

  @examples

    ```go {file="https://github.com/user/repo/blob/main/main.go" linenos=true}
    fmt.Println("Hello world!")
    ```

*/ -}}

{{- $content := .Inner -}}
{{- $filePath := .Attributes.file -}}
{{- $trim := .Attributes.trim | default true -}}

{{- if $trim -}}
  {{- $content = strings.TrimSpace $content -}}
{{- end -}}

{{- $isUrl := and $filePath (strings.HasPrefix $filePath "http") -}}
{{- $isExternal := and $isUrl (not (strings.HasPrefix $filePath site.BaseURL)) -}}
{{- $file := cond $isUrl (path.Base $filePath) $filePath -}}

{{- $lang := or .Type .Attributes.lang (strings.TrimPrefix "." (path.Ext $file)) "text" -}}
{{- if in (slice "html" "gotmpl") $lang -}}
  {{- $lang = "go-html-template" -}}
{{- end -}}

<div class="codeblock">
  {{- with $file -}}
    <div class="codeblock-file">
      {{- if $isUrl -}}
        <a class="codeblock-link"
          href="{{ $filePath }}"
          target="_blank"
          rel="noopener noreferrer">
      {{- end -}}

      {{- partial "utils/icon.html" "words" -}}
      {{- . -}}

      {{- if $isExternal -}}
        {{- partial "utils/icon.html" "external" -}}
      {{- end -}}

      {{- if $isUrl -}}
        </a>
      {{- end -}}
    </div>
  {{- end -}}

{{- if transform.CanHighlight $lang -}}
  {{- highlight $content $lang (.Options | default dict) -}}
{{- else -}}
  <pre><code>{{- $content -}}</code></pre>
{{- end -}}
</div>