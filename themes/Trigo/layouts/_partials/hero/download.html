{{- $release := slice -}}
{{- if eq .Type "release" -}}
  {{- $release = . -}}
{{- else -}}
  {{- $release = index (where site.RegularPages "Type" "releases") 0 | default (index (where site.Sites.Default.RegularPages "Type" "releases") 0) -}}
{{- end -}}

{{- $params := $release.Params -}}
{{- $platforms := slice -}}
{{- $downloadPage := site.GetPage "download" | default (site.Sites.Default.GetPage "download") -}}
{{- with $downloadPage.Params.platforms -}}
  {{- $platforms = . -}}
{{- end -}}

<div class="download-box">
  {{- range $platform := $platforms -}}
    <div class="card" id="{{ $platform.id }}" style="order: {{ $platform.order }};">

      <span popover id="{{ $platform.id }}-arch"></span>
      <button class="card-icon"
        type="button"
        popovertarget="{{ $platform.id }}-arch"
        title="{{ $platform.label }}">
        {{- with (partial "utils/icon.html" $platform.id) -}}
          <span class="icon">{{ . }}</span>
        {{- end -}}
        <br>
        <span>{{- $platform.label -}}</span>
      </button>

      {{- range $download := $platform.downloads -}}
        {{- with index $params (printf "%s_%s" $platform.id $download.key) -}}
          <a class="card-icon app-build"
            href="{{ . }}"
            data-url="{{ . }}"
            alt="{{ $download.alt }}"
            aria-label="{{ $download.label }}"
            title="{{ $download.label }}"
            target="_blank"
            rel="noopener noreferrer">
            {{- with (partial "utils/icon.html" $download.key) -}}
              <span class="icon">{{ . }}</span>
            {{- end -}}
            <br>
            <span>{{- $platform.label -}}</span>
          </a>
        {{- end -}}
      {{- end -}}

    </div>
  {{- end -}}
</div>

<h4 class="description">
  {{- printf "%s %s Â· %s"
    (i18n "download" | default "Download")
    $params.version
    ($params.version_date | time.Format ":date_long")
  -}}
</h4>

{{- $thanks := site.GetPage "thanks" | default (site.Sites.Default.GetPage "thanks") -}}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.app-build').forEach(function(link) {
      link.addEventListener('click', function(event) {
        event.preventDefault();

        const fileUrl = link.dataset.url || link.href;
        window.open(fileUrl, '_blank');

        const thanksUrl = "{{ $thanks.RelPermalink }}";
        setTimeout(function() {
          window.location.href = thanksUrl;
        }, 1000);
      });
    });
  });
</script>