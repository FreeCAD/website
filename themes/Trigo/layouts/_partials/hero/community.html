{{- /* Public Calendar on Community page:

  - Get ICS Calendar from hosted service (currently open-web-calendar).
  - Set some attributes from Site config and others directly here.
  - Render iframe with nicer layout.
  - Display link to ICS Calendar or file.
  - Script to allow Calendar skin switch based on chroma.
*/ -}}

{{- with site.Params.calendar -}}

  {{- $cal := . -}}
  {{- $host := .host | safeURL -}}
  {{- $query := slice -}}

  {{- range $key := slice "url" "title" "skin" "target" -}}
    {{- with index $cal $key -}}
      {{- $query = $query | append (printf "%s=%s" $key (urlquery .)) -}}
    {{- end -}}
  {{- end -}}

  {{- with .tabs -}}
    {{- range . -}}
      {{- $query = $query | append (printf "tabs=%s" (urlquery .)) -}}
    {{- end -}}
  {{- end -}}

  {{- $menu := .menu | default false -}}
  {{- range $menus := slice "calendar_names" "description" "title" -}}
    {{- $query = $query | append (printf "menu_shows_%s=%t" $menus $menu) -}}
  {{- end -}}

  {{- $css := urlquery ".hamburger-menu,.status-window{display:none;}" -}}
  {{- $query = $query | append (printf "css=%s" $css) -}}

  {{- $query = $query | append "prefer_browser_language=true" -}}
  {{- $query = $query | append "loader=" -}}

  {{- $query := delimit $query "&" -}}

  <iframe id="open-web-calendar"
    class="calendar"
    src="{{ printf "%s?%s" $host $query }}"
    sandbox="allow-scripts allow-same-origin allow-top-navigation"
    allowTransparency="true"
    frameborder="0">
  </iframe>

  {{- $label := i18n "ics_calendar" | default "ICS Calendar" -}}
  {{- $base := "https://calendar.google.com/calendar/embed?src=" -}}

  {{- $match := findRE `/ical/([^/]+)/` .url -}}
  {{- $id := cond $match (index $match 0 | replaceRE `/ical/([^/]+)/` "${1}") "" -}}
  {{- $href := cond $match (printf "%s%s" $base $id) .url -}}

  <a href="{{ $href }}"
    class="hero-button"
    title="{{ $label }}"
    target="_blank"
    {{ if not $match }}download{{ end }}>
    {{ $label }}
  </a>


  <script>
    function updateCalendarSkin() {
      const iframe = document.getElementById('open-web-calendar');
      if (!iframe) return;

      const isDark = document.documentElement.classList.contains('dark');
      const skin = isDark ? 'dark' : 'terrace';

      const url = new URL(iframe.src);
      url.searchParams.set('skin', skin);

      const newSrc = url.toString();
      if (iframe.src !== newSrc) {
        iframe.src = newSrc;
      }
    }

    document.addEventListener('DOMContentLoaded', updateCalendarSkin);

    const observer = new MutationObserver(updateCalendarSkin);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });
  </script>

{{- end -}}