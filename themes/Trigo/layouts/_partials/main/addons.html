{{- /* Addons catalog:

  - Get Addon Catalog Cache from Data JSON file.
  - Pick versions (main/master branch).
  - Sort by last update.
  - Get Addon metadata, clean some (specially for icon).
  - Display Addon data in cards.
*/ -}}

{{- $defaultIcon := resources.Get site.Params.defaultIcon -}}
{{- $catalog := site.Data.addon_catalog_cache -}}

{{- if not $catalog -}}{{- return -}}{{- end -}}

{{- $entries := slice -}}
{{- range $versions := $catalog -}}
  {{- $main := where $versions "git_ref" "in" (slice "main" "master") -}}
  {{- $item := (index $main 0) | default (index $versions 0) -}}
  {{- if $item.metadata -}}
    {{- $entries = $entries | append (dict "item" $item) -}}
  {{- end -}}
{{- end -}}

{{- $sorted := sort $entries "item.last_update_time" "desc" -}}

<div class="cards">
  {{- range $sorted -}}

    {{- $item := .item -}}
    {{- $meta := $item.metadata -}}

    {{- /* Clean repository name and detect provider. */ -}}
    {{- $repo := $item.repository | default "" -}}
    {{- if strings.HasSuffix $repo ".git" -}}
      {{- $repo = replace $repo ".git" "" -}}
    {{- end -}}
    {{- $isGitHub := strings.Contains $repo "github" -}}
    {{- $isGitLab := strings.Contains $repo "gitlab" -}}
    {{- $isCodeberg := strings.Contains $repo "codeberg" -}}

    {{- /* Get base raw file URL. */ -}}
    {{- $raw := cond $isGitHub
      (printf "https://raw.githubusercontent.com/%s/refs/heads/%s"
        (replace $repo "https://github.com/" "") $item.git_ref)
      (cond $isGitLab
        (printf "%s/raw/%s" $repo $item.git_ref)
        (cond $isCodeberg
          (printf "%s/raw/branch/%s" $repo $item.git_ref)
          "")) -}}

    {{- /* Clean icon path or get default icon. */ -}}
    {{- $icon := cond (and $meta.icon (ne $raw ""))
      (printf "%s/%s" $raw (replaceRE "(\\.\\.?/)+" "" $meta.icon))
      $defaultIcon.RelPermalink -}}

    <a class="card"
      href="{{ $item.repository }}">

      <div class="card-title">
        <div class="addon-icon">
          <img src="{{ $icon }}" alt="{{ i18n "icon" | default "icon" }}">
        </div>

        {{- with $meta.name -}}
          <h3 class="addon-title">{{- . | title -}}</h3>
        {{- end -}}
      </div>

      {{- with $meta.description -}}
        <p class="card-description">{{- truncate 240 . -}}</p>
      {{- end -}}

      <div class="card-metadata">
        {{- with $meta.version -}}
          <span class="meta">
            {{- with (partial "utils/icon.html" "tags") -}}
              <span class="icon">{{ . }}</span>
            {{- end -}}
            {{- . -}}
          </span>
        {{- end -}}

        {{- with $item.last_update_time -}}
          <span class="meta">
            {{- with (partial "utils/icon.html" "date") -}}
              <span class="icon">{{ . }}</span>
            {{- end -}}
            {{- time . | time.Format ":date_medium" -}}
          </span>
        {{- end -}}

        {{- with $meta.maintainer -}}
          <span class="meta">
            {{- with (partial "utils/icon.html" "authors") -}}
              <span class="icon">{{ . }}</span>
            {{- end -}}
            {{- truncate 30 . -}}
          </span>
        {{- end -}}
      </div>
    </a>

  {{- end -}}
</div>
